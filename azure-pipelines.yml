trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: "windows-latest"

variables:
  BuildConfiguration: "Release"

stages:
- stage: CI
  jobs:
  - job: Backend
    displayName: "Backend - build & test"
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: "sdk"
        version: "8.x"

    - script: |
        cd backend/LoginApi
        dotnet restore
        dotnet build -c $(BuildConfiguration) --no-restore
        dotnet test -c $(BuildConfiguration) --no-build
      displayName: "dotnet restore/build/test"
    - script: |
        cd backend/LoginApi
        mkdir "$(Build.ArtifactStagingDirectory)\backend" || echo "backend folder exists"
        dotnet publish -c $(BuildConfiguration)
      displayName: "Backend publish"
    - script: |
        echo "ArtifactStagingDirectory=$(Build.ArtifactStagingDirectory)"
        echo "CurrentDir:"
        cd
        echo "List staging root:"
        dir "$(Build.ArtifactStagingDirectory)"
        echo "List staging backend:"
        dir "$(Build.ArtifactStagingDirectory)\backend"
      displayName: "Debug: list publish output"
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: "backend/LoginApi/bin/$(BuildConfiguration)/net8.0/publish"
        artifact: "backend"
      displayName: "Publish pipleline backend artifacts"

   

  - job: Frontend
    displayName: "Frontend - build"
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: "20.x"

    - script: npm ci
      workingDirectory: "$(Build.SourcesDirectory)/frontend/login-ui"
      displayName: "npm ci"

    - script: npm run build
      workingDirectory: "$(Build.SourcesDirectory)/frontend/login-ui"
      displayName: "npm run build"

    - powershell: |
        Write-Host "SourcesDirectory = $(Build.SourcesDirectory)"
        Write-Host "== List login-ui root =="
        Get-ChildItem -Force "$(Build.SourcesDirectory)\frontend\login-ui" | Format-Table

        Write-Host "== Check dist path =="
        if (Test-Path "$(Build.SourcesDirectory)\frontend\login-ui\dist") {
          Write-Host "dist exists ✅"
          Get-ChildItem "$(Build.SourcesDirectory)\frontend\login-ui\dist" -Recurse | Select-Object -First 200
        } else {
          Write-Host "dist NOT found ❌"
          Write-Host "== Search dist folders under frontend/login-ui =="
          Get-ChildItem "$(Build.SourcesDirectory)\frontend\login-ui" -Directory -Recurse |
            Where-Object { $_.Name -eq "dist" } |
            ForEach-Object { Write-Host "FOUND dist at:" $_.FullName }

        Write-Host "== Search dist folders under repo =="
        Get-ChildItem "$(Build.SourcesDirectory)" -Directory -Recurse |
          Where-Object { $_.Name -eq "dist" } |
          ForEach-Object { Write-Host "FOUND dist at:" $_.FullName }

        throw "dist not found, fail the job"
        }
      displayName: "Debug: locate dist"

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: "$(Build.SourcesDirectory)/frontend/login-ui/dist"
        artifact: "frontend"
      displayName: "Publish pipeline frontend artifacts"

